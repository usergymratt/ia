<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Pro Steven - Logo Final y IA Mejorada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --main-red: #dc2626; --dark-bg: #101010; --card-bg-opaque: #181818; --card-bg-translucent: rgba(24, 24, 24, 0.85); --text-light: #e5e5e5; --text-dark: #a3a3a3; }
        
        body { 
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text-light);
            transition: background-image 0.4s ease-in-out;
        }

        .bg-resumen {
            background-image: linear-gradient(rgba(16, 16, 16, 0.65), rgba(16, 16, 16, 0.65)), url('https://images.pexels.com/photos/3253501/pexels-photo-3253501.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .bg-fit-ai {
            background-image: linear-gradient(rgba(16, 16, 16, 0.65), rgba(16, 16, 16, 0.65)), url('https://images.pexels.com/photos/4164844/pexels-photo-4164844.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .bg-nutricion {
            background-image: linear-gradient(rgba(16, 16, 16, 0.65), rgba(16, 16, 16, 0.65)), url('https://images.pexels.com/photos/6456299/pexels-photo-6456299.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .bg-entrenamiento {
            background-image: linear-gradient(rgba(16, 16, 16, 0.65), rgba(16, 16, 16, 0.65)), url('https://images.pexels.com/photos/1552242/pexels-photo-1552242.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .bg-progreso {
            background-image: linear-gradient(rgba(16, 16, 16, 0.65), rgba(16, 16, 16, 0.65)), url('https://images.pexels.com/photos/2294361/pexels-photo-2294361.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .bg-recursos {
            background-image: linear-gradient(rgba(16, 16, 16, 0.65), rgba(16, 16, 16, 0.65)), url('https://images.pexels.com/photos/841130/pexels-photo-841130.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }

        .nav-link.active { background-color: var(--main-red); color: white; }
        .nav-link:not(.active) { color: var(--text-dark); hover:bg-gray-800; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .chart-container { position: relative; margin: auto; height: 280px; width: 280px; }
        @media (min-width: 640px) { .chart-container { height: 320px; width: 320px; } }
        .workout-day-btn.active { background-color: var(--main-red); color: white; }
        .workout-day-btn:not(.active) { background-color: #262626; color: var(--text-dark); hover:bg-gray-700; border-color: #404040; }
        .card { 
            background-color: var(--card-bg-translucent); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid #262626; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); 
            padding: 1.5rem; 
            transition: all 0.3s; 
        }
        .card:hover { border-color: var(--main-red); }
        .nav-link-mobile.active { border-top: 2px solid var(--main-red); color: var(--main-red); }
        .nav-link-mobile.active > span { color: var(--main-red); font-weight: 600; }
        .form-input, .form-textarea { background-color: #262626; border: 1px solid #404040; border-radius: 0.375rem; padding: 0.5rem 0.75rem; color: var(--text-light); width: 100%; }
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-dark); }
        .form-input:focus, .form-textarea:focus { outline: none; box-shadow: 0 0 0 2px var(--main-red); border-color: var(--main-red); }
        .btn-primary { background-color: var(--main-red); color: white; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; cursor: pointer; text-align: center;}
        .btn-primary:hover { background-color: #b91c1c; }
        .btn-primary:disabled { background-color: #7f1d1d; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background-color: #404040; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; cursor: pointer; font-size: 0.75rem; }
        .btn-secondary:hover { background-color: #525252; }
        .btn-secondary:disabled { background-color: #262626; cursor: not-allowed; opacity: 0.7; }
        .btn-danger { background-color: #991b1b; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; }
        .btn-danger:hover { background-color: #7f1d1d; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--main-red); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar-bg { background-color: #262626; border-radius: 0.375rem; overflow: hidden; }
        .progress-bar { background-color: var(--main-red); height: 100%; transition: width 0.5s ease-in-out; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-container { position: relative; margin: auto; top: 50%; transform: translateY(-50%); width: 90%; max-width: 500px; padding: 20px; background: var(--card-bg-opaque); border-radius: 0.75rem; border: 1px solid #262626; text-align: center; }
        .edit-input { background-color: #3a3a3a; border: 1px solid #5a5a5a; }
    </style>
</head>
<body class="antialiased bg-resumen">
    <div id="barcode-scanner-modal" class="modal-overlay"><div class="modal-container"><h3 class="text-xl font-bold text-center text-white mb-4">Apunta al c√≥digo de barras</h3><video id="video-scanner" class="w-full h-auto rounded-lg"></video><button id="close-scanner-btn" class="btn-primary w-full mt-4">Cancelar</button></div></div>
    <div id="photo-capture-modal" class="modal-overlay"><div class="modal-container"><h3 class="text-xl font-bold text-center text-white mb-4">Apunta a tu comida</h3><video id="video-capture" class="w-full h-auto rounded-lg" autoplay playsinline></video><div id="capture-controls" class="flex gap-4 mt-4"><button id="capture-photo-btn" class="btn-primary flex-1">Capturar Foto</button><button id="cancel-capture-btn" class="btn-secondary flex-1">Cancelar</button></div></div></div>
    <div id="ai-modal" class="modal-overlay"><div class="modal-container max-w-2xl"><div class="flex justify-between items-center pb-3 border-b border-gray-700"><h3 id="ai-modal-title" class="text-xl font-bold text-white text-left"></h3><button id="ai-modal-close" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div><div id="ai-modal-content-wrapper" class="p-4 overflow-y-auto max-h-[70vh] text-left"><div id="ai-modal-loader" class="hidden justify-center items-center p-12"><div class="loader"></div></div><div id="ai-modal-content"></div></div></div></div>
    <div id="alert-modal" class="modal-overlay"><div class="modal-container"><p id="alert-modal-message" class="text-white mb-6"></p><div id="alert-modal-buttons" class="flex justify-center gap-4"></div></div></div>

    <div class="min-h-screen pb-16 md:pb-0">
        <!-- ===== HEADER CON LOGO DE FISICOCULTURISTA ===== -->
        <header class="bg-black/50 backdrop-blur-md shadow-lg sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                        <!-- NUEVO LOGO SVG FISICOCULTURISTA -->
                        <svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M6.75 6.75C8.16421 6.75 9.33333 7.91921 9.33333 9.33333C9.33333 10.7475 8.16421 11.9167 6.75 11.9167C5.33579 11.9167 4.16667 10.7475 4.16667 9.33333C4.16667 7.91921 5.33579 6.75 6.75 6.75ZM6.75 8.25C6.19772 8.25 5.75 8.70181 5.75 9.24542C5.75 9.32458 5.75 9.49167 5.75 9.49167C5.83579 10.0279 6.24188 10.4167 6.75 10.4167C7.25812 10.4167 7.66421 10.0279 7.75 9.49167C7.75 9.49167 7.75 9.32458 7.75 9.24542C7.75 8.70181 7.30228 8.25 6.75 8.25ZM20.75 11.5833C20.75 12.3923 20.0923 13.0833 19.25 13.0833C18.4077 13.0833 17.75 12.3923 17.75 11.5833C17.75 10.7744 18.4077 10.0833 19.25 10.0833C20.0923 10.0833 20.75 10.7744 20.75 11.5833ZM15.4167 4.66667C15.4167 3.85771 14.759 3.16667 13.9167 3.16667C13.0744 3.16667 12.4167 3.85771 12.4167 4.66667C12.4167 5.47562 13.0744 6.16667 13.9167 6.16667C14.759 6.16667 15.4167 5.47562 15.4167 4.66667ZM18.5 7.66667C16.9739 7.66667 15.6946 8.74608 15.4674 10.2083H15.25C14.2835 10.2083 13.4167 9.34151 13.4167 8.375V8C13.4167 7.15771 12.759 6.5 11.9167 6.5C11.0744 6.5 10.4167 7.15771 10.4167 8V12.75C10.4167 14.8211 12.0956 16.5 14.1667 16.5H14.5C14.7761 16.5 15 16.2761 15 16V13.25C15 12.6977 15.4477 12.25 16 12.25H16.25C16.8023 12.25 17.25 12.6977 17.25 13.25V16C17.25 16.2761 17.4739 16.5 17.75 16.5H18.0833C19.9603 16.5 21.5 14.9943 21.5 13.125V11.5833C21.5 9.41223 19.9943 7.66667 18.5 7.66667ZM11.1667 20.8333L10 17.25H8.25L7.08333 20.8333H11.1667Z"/>
                        </svg>
                        <h1 class="text-2xl font-black tracking-wider text-white">STEVEN</h1>
                    </div>
                    <nav class="hidden md:flex space-x-2" id="main-nav">
                        <a href="#" data-tab="resumen" class="nav-link active px-3 py-2 rounded-md text-sm font-medium">Resumen</a>
                        <a href="#" data-tab="fit-ai" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Fit-AI</a>
                        <a href="#" data-tab="nutricion" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Nutrici√≥n</a>
                        <a href="#" data-tab="entrenamiento" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Entrenamiento</a>
                        <a href="#" data-tab="progreso" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Progreso</a>
                        <a href="#" data-tab="recursos" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Recursos</a>
                    </nav>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <section id="resumen" class="content-section active">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-bold tracking-tight sm:text-4xl text-transparent bg-clip-text bg-gradient-to-r from-white to-red-400">Tu Panel de Control</h2>
                        <p class="mt-4 text-lg text-gray-400">Resumen de tus objetivos y estado actual.</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                        <div class="card lg:col-span-1 flex flex-col items-center text-center h-full">
                           <!-- NUEVO LOGO SVG FISICOCULTURISTA -->
                           <svg class="h-24 w-24 text-white mb-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path d="M6.75 6.75C8.16421 6.75 9.33333 7.91921 9.33333 9.33333C9.33333 10.7475 8.16421 11.9167 6.75 11.9167C5.33579 11.9167 4.16667 10.7475 4.16667 9.33333C4.16667 7.91921 5.33579 6.75 6.75 6.75ZM6.75 8.25C6.19772 8.25 5.75 8.70181 5.75 9.24542C5.75 9.32458 5.75 9.49167 5.75 9.49167C5.83579 10.0279 6.24188 10.4167 6.75 10.4167C7.25812 10.4167 7.66421 10.0279 7.75 9.49167C7.75 9.49167 7.75 9.32458 7.75 9.24542C7.75 8.70181 7.30228 8.25 6.75 8.25ZM20.75 11.5833C20.75 12.3923 20.0923 13.0833 19.25 13.0833C18.4077 13.0833 17.75 12.3923 17.75 11.5833C17.75 10.7744 18.4077 10.0833 19.25 10.0833C20.0923 10.0833 20.75 10.7744 20.75 11.5833ZM15.4167 4.66667C15.4167 3.85771 14.759 3.16667 13.9167 3.16667C13.0744 3.16667 12.4167 3.85771 12.4167 4.66667C12.4167 5.47562 13.0744 6.16667 13.9167 6.16667C14.759 6.16667 15.4167 5.47562 15.4167 4.66667ZM18.5 7.66667C16.9739 7.66667 15.6946 8.74608 15.4674 10.2083H15.25C14.2835 10.2083 13.4167 9.34151 13.4167 8.375V8C13.4167 7.15771 12.759 6.5 11.9167 6.5C11.0744 6.5 10.4167 7.15771 10.4167 8V12.75C10.4167 14.8211 12.0956 16.5 14.1667 16.5H14.5C14.7761 16.5 15 16.2761 15 16V13.25C15 12.6977 15.4477 12.25 16 12.25H16.25C16.8023 12.25 17.25 12.6977 17.25 13.25V16C17.25 16.2761 17.4739 16.5 17.75 16.5H18.0833C19.9603 16.5 21.5 14.9943 21.5 13.125V11.5833C21.5 9.41223 19.9943 7.66667 18.5 7.66667ZM11.1667 20.8333L10 17.25H8.25L7.08333 20.8333H11.1667Z"/>
                            </svg>
                            <h3 class="text-3xl font-black tracking-wider text-white">STEVEN</h3>
                            <p class="text-md font-semibold text-gray-400 mt-1 uppercase tracking-widest">NO PAIN NO GAIN</p>
                            <div class="w-full border-t border-gray-700 my-6"></div>
                            <div class="w-full text-left space-y-3">
                                <h4 class="text-lg font-bold text-center text-red-400">Objetivo Actual</h4>
                                <p class="text-center text-gray-300">M√°xima definici√≥n muscular.</p>
                            </div>
                        </div>
                        <div class="lg:col-span-2 grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                            <div class="flex flex-col items-center"><div class="chart-container"><canvas id="macroChart"></canvas></div></div>
                            <div class="space-y-6">
                                <div class="card text-center"><h3 class="text-lg font-semibold text-gray-500">Calor√≠as Totales</h3><p id="total-calorias" class="text-5xl font-bold text-white">2270</p><p class="text-sm text-gray-400">kcal/d√≠a</p></div>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="card text-center"><h4 class="text-md font-semibold text-red-500">Prote√≠nas</h4><p id="gramos-proteina" class="text-3xl font-bold">225g</p></div>
                                    <div class="card text-center"><h4 class="text-md font-semibold text-gray-300">Carbs</h4><p id="gramos-carbs" class="text-3xl font-bold">200g</p></div>
                                    <div class="card text-center"><h4 class="text-md font-semibold text-gray-500">Grasas</h4><p id="gramos-grasas" class="text-3xl font-bold">63g</p></div>
                                </div>
                                <div class="card text-center"><button id="change-goal-ai-btn" class="btn-primary w-full">‚ú® Ajustar Objetivo con IA</button></div>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="fit-ai" class="content-section"><div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">ü§ñ Tu Asistente Nutricional</h2><p class="mt-4 text-lg text-gray-400">Usa IA para generar recetas, analizar comidas y planificar tu d√≠a.</p></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8"><div class="card space-y-4"><h3 class="text-xl font-bold text-center text-red-500">‚ú® Buscar Receta</h3><form id="recipe-search-form" class="flex gap-2"><input type="search" id="recipe-search-input" placeholder="Ej: Omelette de espinacas..." class="form-input w-full"><button type="submit" class="btn-primary">üîé</button></form><p class="text-xs text-center text-gray-500">La IA generar√° una receta y sus macros.</p></div><div class="card space-y-4 flex flex-col justify-center items-center text-center"><h3 class="text-xl font-bold text-red-500">Escanear Producto</h3><p class="text-sm text-gray-400 flex-grow">Usa tu c√°mara para obtener la informaci√≥n nutricional de un producto al instante.</p><button id="scan-barcode-btn" class="btn-primary w-full mt-4">üì∑ Escanear</button></div><div class="card space-y-4"><h3 class="text-xl font-bold text-center text-red-500">‚ú® Analizar Comida</h3><input type="file" id="food-image-input" accept="image/*" class="form-input w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-900 file:text-red-100 hover:file:bg-red-800"><div class="grid grid-cols-2 gap-2 mt-2"><button id="analyze-image-btn" class="btn-primary w-full">üñºÔ∏è Analizar</button><button id="take-food-photo-btn" class="btn-primary w-full">üì∏ Tomar Foto</button></div><img id="image-preview" src="" class="hidden w-full max-w-xs mx-auto rounded-lg mt-4"/></div></div><div class="mt-8"><div class="card text-center"><h3 class="text-xl font-bold text-red-500">‚ú® Tu Plan de Comidas Diario</h3><p class="text-sm text-gray-400 my-4">Genera un plan de comidas completo para todo el d√≠a que se ajuste perfectly a tus macros objetivos. Puedes especificar tus preferencias.</p><form id="meal-plan-form" class="flex flex-col sm:flex-row gap-2 justify-center"><input type="text" id="meal-plan-prefs" class="form-input flex-grow" placeholder="Preferencias (ej: vegetariano, sin l√°cteos)"><button type="submit" id="generate-meal-plan-btn" class="btn-primary">Generar Plan</button></form></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8"><div class="card space-y-4"><h3 class="text-xl font-bold text-center">Resultado del An√°lisis</h3><div id="ai-result-loader" class="hidden justify-center items-center py-8"><div class="loader"></div></div><div id="ai-result-content" class="text-center text-gray-400">Selecciona una herramienta para empezar.</div></div><div class="card space-y-4"><h3 class="text-xl font-bold text-center">Tu Consumo de Hoy</h3><div id="daily-log-progress"></div><div class="flex justify-between items-center"><h4 class="text-lg font-semibold">Comidas Registradas</h4><button id="clear-log-btn" class="btn-danger">Limpiar</button></div><div id="daily-log-history" class="space-y-3 overflow-auto max-h-60 pr-2"></div></div></div></section>
                <section id="nutricion" class="content-section"><div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Arquitectura Nutricional</h2><p class="mt-4 text-lg text-gray-400">Usa la matriz para personalizar tus comidas.</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12"><div class="card"><h3 class="text-xl font-bold mb-4">Plan de Alimentaci√≥n</h3><ul class="space-y-3 text-gray-300"><li><strong style="color: var(--main-red);">Comida 1:</strong> 5 claras + 1 huevo, 1/2 aguacate.</li><li><strong style="color: var(--main-red);">Comida 2:</strong> 200g yogur griego, frutos rojos.</li><li><strong style="color: var(--main-red);">Comida 3 (Pre):</strong> 200g pollo, 200g arroz, br√≥coli.</li><li><strong style="color: var(--main-red);">Comida 4 (Post):</strong> 40g whey. Luego: 180g lomo, 250g papa.</li><li><strong style="color: var(--main-red);">Comida 5:</strong> 200g cottage o 180g salm√≥n, almendras.</li></ul></div><div class="card"><h3 class="text-xl font-bold mb-4">Estrategia y Flexibilidad</h3><div class="space-y-4 text-gray-300"><p><strong style="color: var(--main-red);">Frecuencia:</strong> 4-6 comidas para optimizar MPS.</p><p><strong style="color: var(--main-red);">Timing de Carbs:</strong> Concentra carbs pre/post entreno.</p><p><strong style="color: var(--main-red);">Consistencia:</strong> Es la clave, mant√©n calor√≠as y prote√≠na estables.</p><p><strong style="color: var(--main-red);">Hidrataci√≥n:</strong> M√≠nimo 3-4 litros de agua/d√≠a.</p></div></div></div><div class="card"><h3 class="text-xl font-bold mb-4 text-center">Matriz de Selecci√≥n de Alimentos</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-400"><thead class="text-xs text-gray-300 uppercase bg-black/30"><tr><th class="px-6 py-3">Prote√≠na</th><th class="px-6 py-3">Carbs</th><th class="px-6 py-3">Grasas</th><th class="px-6 py-3">Verduras/Frutas</th></tr></thead><tbody class="divide-y divide-gray-800"><tr><td class="px-6 py-4">Pechuga de pollo/pavo</td><td class="px-6 py-4">Avena, arroz</td><td class="px-6 py-4">Aguacate</td><td class="px-6 py-4">Br√≥coli, espinaca</td></tr><tr><td class="px-6 py-4">Lomo de res/cerdo</td><td class="px-6 py-4">Papa, batata, yuca</td><td class="px-6 py-4">Aceite de oliva</td><td class="px-6 py-4">Coliflor, piment√≥n</td></tr><tr><td class="px-6 py-4">Pescado blanco</td><td class="px-6 py-4">Pl√°tano, pasta</td><td class="px-6 py-4">Nueces, almendras</td><td class="px-6 py-4">Cebolla, tomate</td></tr></tbody></table></div></div></section>
                
                <!-- ===== SECCI√ìN DE ENTRENAMIENTO MODIFICADA ===== -->
                <section id="entrenamiento" class="content-section">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Protocolo de Entrenamiento</h2>
                        <p class="mt-4 text-lg text-gray-400">Enfoque en t√©cnica, RIR y sobrecarga progresiva.</p>
                        <!-- Contenedor para los botones de acci√≥n -->
                        <div id="workout-actions-container" class="mt-6 flex justify-center items-center gap-4">
                            <button id="manual-edit-workout-btn" class="btn-secondary text-lg py-3 px-6">‚úèÔ∏è Modificar Manualmente</button>
                            <button id="modify-workout-ai-btn" class="btn-primary text-lg py-3 px-6">ü¶æ Editar Rutina con IA</button>
                        </div>
                    </div>
                    <div class="flex justify-center flex-wrap items-center gap-2 mb-8" id="workout-nav">
                        <!-- Los botones de los d√≠as se renderizar√°n aqu√≠ din√°micamente -->
                    </div>
                    <div id="workout-content" class="card">
                        <!-- El contenido de la rutina se renderizar√° aqu√≠ -->
                    </div>
                </section>

                <section id="progreso" class="content-section"><div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Tu Centro de Progreso</h2><p class="mt-4 text-lg text-gray-400">Registra tus m√©tricas, notas y levantamientos. La data es poder.</p><div class="mt-6"><button id="analyze-progress-btn" class="btn-primary text-lg py-3 px-6">‚ú® ¬°Analiza Mi Progreso con IA!</button></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="card space-y-4"><h3 class="text-xl font-bold text-center text-red-500">Registro de Medidas</h3><form id="measurement-form" class="grid grid-cols-2 gap-4"><input type="date" id="measure-date" class="form-input col-span-2"><input type="number" step="0.1" id="measure-weight" placeholder="Peso (kg)" class="form-input"><input type="number" step="0.1" id="measure-waist" placeholder="Cintura (cm)" class="form-input"><input type="number" step="0.1" id="measure-chest" placeholder="Pecho (cm)" class="form-input"><input type="number" step="0.1" id="measure-arm" placeholder="Brazo (cm)" class="form-input"><button type="submit" class="btn-primary col-span-2">Guardar Medidas</button></form><div class="overflow-auto max-h-60"><table class="w-full text-sm text-left"><thead class="text-xs text-red-400 uppercase bg-black/30"><tr><th class="p-2">Fecha</th><th class="p-2">Peso</th><th class="p-2">Cintura</th><th class="p-2">Pecho</th><th class="p-2">Brazo</th><th class="p-2"></th></tr></thead><tbody id="measurements-history" class="divide-y divide-gray-800"></tbody></table></div></div><div class="card space-y-4"><h3 class="text-xl font-bold text-center text-red-500">Bit√°cora de Notas</h3><form id="notes-form" class="space-y-4"><textarea id="note-text" rows="4" class="form-textarea" placeholder="Anota tus victorias, sensaciones, ajustes..."></textarea><div class="grid grid-cols-2 gap-2"><button type="submit" class="btn-primary w-full">Guardar Nota</button><button type="button" id="analyze-wellness-btn" class="btn-primary w-full">‚ú® Analizar Bienestar</button></div></form><div id="notes-history" class="space-y-3 overflow-auto max-h-60 pr-2"></div></div><div class="card lg:col-span-2 space-y-4"><h3 class="text-xl font-bold text-center text-red-500">Registro de Levantamientos</h3><form id="lift-form" class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end"><div class="sm:col-span-2"><label for="lift-exercise" class="text-xs text-gray-400">Ejercicio</label><select id="lift-exercise" class="form-input w-full"></select></div><div><label for="lift-weight" class="text-xs text-gray-400">Peso (kg)</label><input type="number" step="0.5" id="lift-weight" placeholder="kg" class="form-input w-full"></div><div><label for="lift-reps" class="text-xs text-gray-400">Reps</label><input type="number" id="lift-reps" placeholder="Reps" class="form-input w-full"></div><button type="submit" class="btn-primary sm:col-span-4 w-full">Guardar Levantamiento</button></form><div class="flex justify-between items-center"><h4 class="text-lg font-semibold">Historial</h4><select id="lift-filter" class="form-input w-1/2 sm:w-1/3"></select></div><div class="overflow-auto max-h-72"><table class="w-full text-sm text-left"><thead class="text-xs text-red-400 uppercase bg-black/30"><tr><th class="p-2">Fecha</th><th class="p-2">Ejercicio</th><th class="p-2">Peso</th><th class="p-2">Reps</th><th class="p-2"></th></tr></thead><tbody id="lifts-history" class="divide-y divide-gray-800"></tbody></table></div></div></div></section>
                <section id="recursos" class="content-section"><div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Caja de Herramientas</h2><p class="mt-4 text-lg text-gray-400">Conocimiento clave para potenciar tus resultados.</p></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"><div class="card md:col-span-2"><h3 class="text-2xl font-bold mb-4">Calculadoras de Entrenamiento</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h4 class="font-bold text-lg text-red-500 mb-2">Calculadora de 1RM Estimado</h4><form id="1rm-form" class="space-y-3"><input type="number" id="1rm-weight" placeholder="Peso levantado (kg)" class="form-input w-full"><input type="number" id="1rm-reps" placeholder="Repeticiones completadas" class="form-input w-full"><button type="submit" class="btn-primary w-full">Calcular 1RM</button></form><p id="1rm-result" class="mt-3 font-bold text-center text-xl"></p></div><div><h4 class="font-bold text-lg text-red-500 mb-2">Calculadora de Peso por RIR</h4><form id="rir-form" class="space-y-3"><input type="number" id="rir-1rm" placeholder="Tu 1RM estimado (kg)" class="form-input w-full"><input type="number" id="rir-reps" placeholder="Repeticiones objetivo" class="form-input w-full"><input type="number" id="rir-rir" placeholder="RIR deseado (0-3)" class="form-input w-full"><button type="submit" class="btn-primary w-full">Calcular Peso</button></form><p id="rir-result" class="mt-3 font-bold text-center text-xl"></p></div></div></div><div class="card lg:row-start-1 lg:col-start-3"><h3 class="text-2xl font-bold mb-4">‚ú® Stack de Suplementos</h3><form id="supplement-form" class="space-y-3"><p class="text-sm text-gray-400">Describe tu objetivo principal (ej. ganar m√∫sculo, perder grasa) para recibir una sugerencia.</p><input type="text" id="supplement-goal" placeholder="Mi objetivo es..." class="form-input w-full"><button type="submit" class="btn-primary w-full">Generar Sugerencia</button></form></div><div class="card"><h3 class="text-2xl font-bold mb-4">Fundamentales</h3><ul class="text-sm list-disc list-inside text-gray-300 space-y-2"><li><strong>Abdomen:</strong> Sobrecarga progresiva con Crunch en Polea y Elev. de Piernas Colgado.</li><li><strong>Antebrazo:</strong> Atacar con flexi√≥n/extensi√≥n de mu√±eca y trabajo de agarre.</li></ul></div><div class="card"><h3 class="text-2xl font-bold mb-4">Ciencia</h3><ul class="text-sm list-disc list-inside text-gray-300 space-y-2"><li><strong>D√©ficit Cal√≥rico:</strong> Esencial para la oxidaci√≥n de grasa.</li><li><strong>Prote√≠na Elevada:</strong> Clave para la retenci√≥n muscular.</li><li><strong>Sobrecarga Progresiva:</strong> El pilar del progreso.</li></ul></div><div class="card"><h3 class="text-2xl font-bold mb-4">Mindset</h3><ul class="text-sm list-disc list-inside text-gray-300 space-y-2"><li><strong>Consistencia > Perfecci√≥n.</strong></li><li><strong>Paciencia y objetividad.</strong></li><li><strong>Conexi√≥n Mente-M√∫sculo.</strong></li></ul></div></div></section>
            </div>
        </main>
        <div class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-md shadow-[0_-2px_10px_rgba(0,0,0,0.5)] md:hidden h-16"><nav class="flex justify-around items-center h-full" id="mobile-nav"><a href="#" data-tab="resumen" class="nav-link-mobile active flex flex-col items-center text-xs p-1 text-gray-400">üìä<span class="mt-1">Resumen</span></a><a href="#" data-tab="fit-ai" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">ü§ñ<span class="mt-1">Fit-AI</span></a><a href="#" data-tab="nutricion" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">üçé<span class="mt-1">Nutrici√≥n</span></a><a href="#" data-tab="entrenamiento" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">üèãÔ∏è<span class="mt-1">Entreno</span></a><a href="#" data-tab="progreso" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">üìà<span class="mt-1">Progreso</span></a><a href="#" data-tab="recursos" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">üß†<span class="mt-1">Recursos</span></a></nav></div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', function () {
    const savedMacroData = localStorage.getItem('fitnessMacroDataDR');
    let macroData = savedMacroData ? JSON.parse(savedMacroData) : { calorias: 2270, proteina: 225, carbs: 200, grasas: 63 };

    const defaultWorkoutData = {
        '1':{ title:'D√≠a 1: Empuje (Pecho, Hombro, Tr√≠ceps)', description:'√ânfasis en fuerza e hipertrofia.', main_work: [ {name:'Press de Banca con Barra',sets:4,reps:'6-10',rest:'180s',rir:'2'}, {name:'Press Inclinado con Mancuernas',sets:3,reps:'8-12',rest:'120s',rir:'1-2'}, {name:'Press Militar con Barra',sets:4,reps:'6-10',rest:'150s',rir:'2'}, {name:'Elevaciones Laterales',sets:4,reps:'12-15',rest:'75s',rir:'1'}, {name:'Fondos en Paralelas (o M√°quina)',sets:3,reps:'Al fallo',rest:'90s',rir:'0'}, {name:'Extensiones de Tr√≠ceps en Polea',sets:3,reps:'12-15',rest:'75s',rir:'Drop set'} ], specific_work: [ {name:'Crunch en Polea Alta',sets:3,reps:'15-20',rest:'60s',rir:'1'}, {name:'Elevaciones de Piernas Colgado',sets:3,reps:'15-20',rest:'60s',rir:'1'} ], cardio: { name: 'CARDIO LISS', details: '30-45 minutos a ritmo constante (65-75% FC M√°x).' } },
        '2':{ title:'D√≠a 2: Tir√≥n (Espalda, B√≠ceps)', description:'Construcci√≥n de densidad y fuerza.', main_work: [ {name:'Peso Muerto Rumano (RDL)',sets:4,reps:'6-10',rest:'180s',rir:'2'}, {name:'Remo con Barra',sets:4,reps:'6-10',rest:'150s',rir:'2'}, {name:'Remo con Mancuerna',sets:3,reps:'8-12 c/b',rest:'90s',rir:'1-2'}, {name:'Face Pulls',sets:4,reps:'15-20',rest:'75s',rir:'1'}, {name:'Curl con Barra Z',sets:3,reps:'8-12',rest:'90s',rir:'1-2'} ], specific_work: [ {name:'Curl Martillo',sets:3,reps:'10-15',rest:'75s',rir:'1'}, {name:'Curl de Mu√±eca (Flex/Ext)',sets:'3 c/u',reps:'15-20',rest:'60s',rir:'1'} ] },
        '3':{ title:'D√≠a 3: Piernas y Core', description:'Enfoque en hipertrofia y estabilidad.', main_work: [ {name:'Prensa de Piernas',sets:4,reps:'10-15',rest:'120s',rir:'1-2'}, {name:'Hip Thrust',sets:3,reps:'8-12',rest:'120s',rir:'1'}, {name:'Curl Femoral',sets:3,reps:'12-15',rest:'90s',rir:'1'}, {name:'Extensiones de Cu√°driceps',sets:3,reps:'12-18',rest:'75s',rir:'1'}, {name:'Abducci√≥n de Cadera',sets:3,reps:'15-20',rest:'60s',rir:'1'}, {name:'Elevaci√≥n de Gemelos',sets:4,reps:'15-20',rest:'60s',rir:'1'} ], specific_work: [ {name:'Plancha con Peso',sets:3,reps:'45-60s',rest:'60s',rir:'N/A'}, {name:'Plancha Lateral',sets:3,reps:'30-45s c/l',rest:'45s',rir:'N/A'} ], cardio: { name: 'CARDIO LISS', details: '30-45 minutos a ritmo constante (65-75% FC M√°x).' } },
        '4':{ title:'D√≠a 4: Espalda y Antebrazo', description:'Alto volumen para amplitud y agarre.', main_work: [ {name:'Jal√≥n al Pecho',sets:4,reps:'8-12',rest:'120s',rir:'1-2'}, {name:'Remo en Polea Baja',sets:4,reps:'8-12',rest:'90s',rir:'1-2'}, {name:'Pullover con Cable',sets:3,reps:'12-15',rest:'75s',rir:'1'}, {name:'P√°jaros (Hombro Posterior)',sets:3,reps:'15-20',rest:'75s',rir:'1'}, {name:'Curl Predicador',sets:3,reps:'8-12',rest:'90s',rir:'1'} ], specific_work: [ {name:'Paseo del Granjero',sets:3,reps:'30-40m',rest:'90s',rir:'N/A'}, {name:'Curl de Concentraci√≥n',sets:3,reps:'10-15 c/b',rest:'60s',rir:'0-1'} ] },
        '5':{ title:'D√≠a 5: Empuje (Hipertrofia)', description:'√ânfasis en estr√©s metab√≥lico y core avanzado.', main_work: [ {name:'Press Inclinado con Barra',sets:4,reps:'8-12',rest:'120s',rir:'1-2'}, {name:'Press Hombros Mancuernas',sets:4,reps:'8-12',rest:'120s',rir:'1-2'}, {name:'Cruces en Polea',sets:3,reps:'12-15',rest:'75s',rir:'Drop set'}, {name:'Elev. Laterales Sentado',sets:4,reps:'15-20',rest:'75s',rir:'1'}, {name:'Ext. Tr√≠ceps sobre Cabeza',sets:3,reps:'10-15',rest:'75s',rir:'1'}, {name:'Press Franc√©s',sets:3,reps:'10-12',rest:'90s',rir:'1'} ], specific_work: [ {name:'Rueda Abdominal',sets:3,reps:'Al fallo',rest:'75s',rir:'0'}, {name:'Rotaciones Rusas (Le√±ador)',sets:3,reps:'10-15 c/l',rest:'60s',rir:'1'} ], cardio: { name: 'CARDIO HIIT', details: '15-20 min. Ejemplo: 1 min sprint, 2 min recuperaci√≥n. Repetir.' } }
    };
    
    const savedWorkoutData = localStorage.getItem('fitnessWorkoutDataDR');
    let workoutData = savedWorkoutData ? JSON.parse(savedWorkoutData) : JSON.parse(JSON.stringify(defaultWorkoutData));
    
    let activeWorkoutDay = '1'; 
    let isEditingWorkout = false; // Estado para controlar el modo de edici√≥n manual
    let macroChartInstance;
    let codeReader; 
    let cameraStream;

    const navLinks = document.querySelectorAll('#main-nav a, #mobile-nav a');
    const contentSections = document.querySelectorAll('.content-section');
    const workoutNav = document.getElementById('workout-nav');
    const workoutContent = document.getElementById('workout-content');
    const workoutActionsContainer = document.getElementById('workout-actions-container');
    const manualEditBtn = document.getElementById('manual-edit-workout-btn');
    const aiEditBtn = document.getElementById('modify-workout-ai-btn');
    const backgroundClasses = ['bg-resumen', 'bg-fit-ai', 'bg-nutricion', 'bg-entrenamiento', 'bg-progreso', 'bg-recursos'];

    function updateBackground(tabId) { document.body.classList.remove(...backgroundClasses); document.body.classList.add(`bg-${tabId}`); }

    navLinks.forEach(link => { link.addEventListener('click', e => { e.preventDefault(); const tabId = e.currentTarget.dataset.tab; updateBackground(tabId); contentSections.forEach(s => s.classList.remove('active')); document.getElementById(tabId).classList.add('active'); navLinks.forEach(l => { l.classList.remove('active'); if (l.dataset.tab === tabId) { l.classList.add('active'); } }); window.scrollTo({ top: 0, behavior: 'smooth' }); }); });
    
    const alertModal = document.getElementById('alert-modal');
    const alertModalMessage = document.getElementById('alert-modal-message');
    const alertModalButtons = document.getElementById('alert-modal-buttons');

    function showAlert(message) { alertModalMessage.textContent = message; alertModalButtons.innerHTML = `<button id="alert-ok-btn" class="btn-primary">OK</button>`; alertModal.style.display = 'block'; document.getElementById('alert-ok-btn').onclick = () => alertModal.style.display = 'none'; }
    function showConfirm(message, onConfirm) { alertModalMessage.textContent = message; alertModalButtons.innerHTML = `<button id="confirm-cancel-btn" class="btn-secondary">Cancelar</button><button id="confirm-ok-btn" class="btn-danger">Confirmar</button>`; alertModal.style.display = 'block'; document.getElementById('confirm-ok-btn').onclick = () => { alertModal.style.display = 'none'; onConfirm(); }; document.getElementById('confirm-cancel-btn').onclick = () => alertModal.style.display = 'none'; }

    function renderMacroChart() { if (macroChartInstance) { macroChartInstance.destroy(); } macroChartInstance = new Chart(document.getElementById('macroChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Prote√≠na', 'Carbs', 'Grasas'], datasets: [{ data: [macroData.proteina * 4, macroData.carbs * 4, macroData.grasas * 9], backgroundColor: ['#dc2626', '#f5f5f5', '#525252'], borderColor: 'rgba(24, 24, 24, 0.85)', borderWidth: 4, hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: '#e5e5e5' }}, tooltip: { callbacks: { label: c => `${c.label}: ${c.raw.toFixed(0)} kcal (${((c.raw/c.chart.getDatasetMeta(0).total)*100).toFixed(1)}%)` }}}} }); }
    function updateMacroDisplay() { document.getElementById('total-calorias').textContent = Math.round(macroData.calorias); document.getElementById('gramos-proteina').textContent = `${Math.round(macroData.proteina)}g`; document.getElementById('gramos-carbs').textContent = `${Math.round(macroData.carbs)}g`; document.getElementById('gramos-grasas').textContent = `${Math.round(macroData.grasas)}g`; renderMacroChart(); renderDailyLog(); }
    
    // ===== L√ìGICA DE ENTRENAMIENTO (MODIFICADA Y MEJORADA) =====
    function saveWorkoutData() {
        localStorage.setItem('fitnessWorkoutDataDR', JSON.stringify(workoutData));
    }

    function renderWorkoutNav() {
        const days = Object.keys(workoutData).sort((a, b) => a - b);
        let buttonsHTML = days.map(day =>
            `<button data-day="${day}" class="workout-day-btn px-4 py-2 text-sm font-bold rounded-md ${day === activeWorkoutDay ? 'active' : ''}">D√≠a ${day}</button>`
        ).join('');

        if (isEditingWorkout) {
            buttonsHTML += `<button id="add-workout-day-btn" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 text-sm font-bold rounded-md ml-2">+ A√±adir D√≠a</button>`;
        }
        workoutNav.innerHTML = buttonsHTML;
    }

    function renderWorkout() {
        if (!workoutData[activeWorkoutDay]) {
            activeWorkoutDay = Object.keys(workoutData)[0] || '1';
        }
        renderWorkoutNav();
        if (isEditingWorkout) {
            renderEditableWorkoutView(activeWorkoutDay);
        } else {
            renderStaticWorkoutView(activeWorkoutDay);
        }
    }

    function renderStaticWorkoutView(day) {
        const data = workoutData[day];
        if (!data) {
            workoutContent.innerHTML = `<p class="text-center text-yellow-400">No hay datos para este d√≠a. Intenta a√±adir uno en el modo de edici√≥n.</p>`;
            return;
        }
        let isModified = defaultWorkoutData[day] ? JSON.stringify(data) !== JSON.stringify(defaultWorkoutData[day]) : true;
        let revertButtonHtml = isModified && defaultWorkoutData[day] ? `<div class="text-center mt-4"><button id="revert-workout-btn" class="btn-secondary">Revertir al Original</button></div>` : '';
        
        const createTableHTML = (exercises) => {
             const header = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="text-left text-red-500 border-b border-gray-700"><th class="p-2">Ejercicio</th><th class="p-2 text-center">Series</th><th class="p-2 text-center">Reps</th><th class="p-2 text-center">Descanso</th><th class="p-2 text-center">RIR</th><th class="p-2 text-center">Asistente IA</th></tr></thead>`;
             const body = `<tbody class="divide-y divide-gray-800">${exercises.map(ex => `<tr class="text-gray-300"><td class="p-2 font-semibold">${ex.name}</td><td class="p-2 text-center">${ex.sets}</td><td class="p-2 text-center">${ex.reps}</td><td class="p-2 text-center">${ex.rest}</td><td class="p-2 text-center font-bold text-red-500">${ex.rir}</td><td class="p-2 text-center space-x-1"><button class="btn-secondary ai-action-btn btn-explain" data-exercise-name="${ex.name}">Explicar</button><button class="btn-secondary ai-action-btn btn-variation" data-exercise-name="${ex.name}">Alternativa</button></td></tr>`).join('')}</tbody>`;
             return `${header}${body}</table></div>`;
        }

        let html = `<h3 class="text-xl font-bold mb-2 text-white">${data.title}</h3><p class="text-gray-400 mb-4">${data.description}</p>`;
        html += createTableHTML(data.main_work || []);
        if (data.specific_work && data.specific_work.length > 0) { html += `<h4 class="text-lg font-semibold mt-6 mb-2 text-red-400">Trabajo Espec√≠fico</h4>`; html += createTableHTML(data.specific_work); }
        if (data.cardio && data.cardio.name) { html += `<h4 class="text-lg font-semibold mt-6 mb-2 text-cyan-400">Cardio Finalizador</h4>`; html += `<div class="bg-black/20 p-4 rounded-lg border border-gray-700"><p class="text-xl font-bold text-center text-white">${data.cardio.name}</p><p class="text-md text-gray-400 text-center mt-1">${data.cardio.details}</p></div>`; }
        
        workoutContent.innerHTML = html + revertButtonHtml;
        populateExerciseSelects();
    }

    function renderEditableWorkoutView(day) {
        const data = workoutData[day];
        
        const createEditableTableHTML = (exercises, type) => {
            let tableRows = exercises.map((ex, index) => `
                <tr data-index="${index}" data-type="${type}">
                    <td class="p-1"><input type="text" class="form-input edit-input" value="${ex.name}" data-field="name"></td>
                    <td class="p-1"><input type="text" class="form-input edit-input w-16 text-center" value="${ex.sets}" data-field="sets"></td>
                    <td class="p-1"><input type="text" class="form-input edit-input w-20 text-center" value="${ex.reps}" data-field="reps"></td>
                    <td class="p-1"><input type="text" class="form-input edit-input w-20 text-center" value="${ex.rest}" data-field="rest"></td>
                    <td class="p-1"><input type="text" class="form-input edit-input w-16 text-center" value="${ex.rir}" data-field="rir"></td>
                    <td class="p-1 text-center"><button class="btn-danger delete-exercise-btn">X</button></td>
                </tr>
            `).join('');

            return `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-red-500 border-b border-gray-700">
                                <th class="p-2">Ejercicio</th><th class="p-2">Series</th><th class="p-2">Reps</th><th class="p-2">Descanso</th><th class="p-2">RIR</th><th></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800">${tableRows}</tbody>
                    </table>
                </div>
                <div class="text-center mt-2"><button class="btn-secondary add-exercise-btn" data-type="${type}">+ A√±adir Ejercicio</button></div>
            `;
        }

        let html = `
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-gray-400">T√≠tulo del D√≠a</label>
                    <input type="text" id="edit-title" class="form-input edit-input" value="${data.title}">
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-400">Descripci√≥n</label>
                    <textarea id="edit-description" class="form-textarea edit-input" rows="2">${data.description}</textarea>
                </div>
            </div>
            <h4 class="text-lg font-semibold mt-6 mb-2 text-red-400">Trabajo Principal</h4>
            <div id="edit-main_work">${createEditableTableHTML(data.main_work || [], 'main_work')}</div>
            
            <h4 class="text-lg font-semibold mt-6 mb-2 text-red-400">Trabajo Espec√≠fico</h4>
            <div id="edit-specific_work">${createEditableTableHTML(data.specific_work || [], 'specific_work')}</div>
            
            <h4 class="text-lg font-semibold mt-6 mb-2 text-cyan-400">Cardio Finalizador</h4>
            <div class="space-y-4 bg-black/20 p-4 rounded-lg border border-gray-700">
                 <div>
                    <label class="text-sm font-bold text-gray-400">Nombre del Cardio</label>
                    <input type="text" id="edit-cardio-name" class="form-input edit-input" value="${data.cardio ? data.cardio.name : ''}">
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-400">Detalles del Cardio</label>
                    <input type="text" id="edit-cardio-details" class="form-input edit-input" value="${data.cardio ? data.cardio.details : ''}">
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-workout-edit-btn" class="btn-secondary text-lg py-2 px-6">Cancelar</button>
                <button id="save-workout-changes-btn" class="btn-primary text-lg py-2 px-6">‚úÖ Guardar Cambios</button>
            </div>
            <div class="border-t border-red-800/50 mt-8 pt-4 text-center">
                 <button id="delete-workout-day-btn" class="btn-danger text-base py-2 px-4">üóëÔ∏è Eliminar D√≠a ${day}</button>
            </div>
        `;
        workoutContent.innerHTML = html;
    }

    function toggleEditMode(edit) {
        isEditingWorkout = edit;
        manualEditBtn.style.display = edit ? 'none' : 'inline-block';
        aiEditBtn.style.display = edit ? 'none' : 'inline-block';
        renderWorkout(); // This will call renderWorkoutNav() internally
    }

    manualEditBtn.addEventListener('click', () => toggleEditMode(true));

    workoutContent.addEventListener('click', e => {
        if (e.target.id === 'save-workout-changes-btn') {
            const newDayData = {
                title: document.getElementById('edit-title').value,
                description: document.getElementById('edit-description').value,
                main_work: [],
                specific_work: [],
                cardio: {
                    name: document.getElementById('edit-cardio-name').value,
                    details: document.getElementById('edit-cardio-details').value,
                }
            };
            
            document.querySelectorAll('#edit-main_work tr[data-index]').forEach(row => {
                const exercise = {};
                row.querySelectorAll('input').forEach(input => {
                    exercise[input.dataset.field] = input.value;
                });
                newDayData.main_work.push(exercise);
            });

            document.querySelectorAll('#edit-specific_work tr[data-index]').forEach(row => {
                const exercise = {};
                row.querySelectorAll('input').forEach(input => {
                    exercise[input.dataset.field] = input.value;
                });
                newDayData.specific_work.push(exercise);
            });

            workoutData[activeWorkoutDay] = newDayData;
            saveWorkoutData();
            toggleEditMode(false);
            showAlert('¬°Rutina actualizada y guardada!');
        }
        if (e.target.id === 'cancel-workout-edit-btn') {
            toggleEditMode(false);
        }
        if (e.target.classList.contains('add-exercise-btn')) {
            const type = e.target.dataset.type;
            const tableBody = document.querySelector(`#edit-${type} tbody`);
            const newIndex = tableBody.rows.length;
            const newRow = tableBody.insertRow();
            newRow.dataset.index = newIndex;
            newRow.dataset.type = type;
            newRow.innerHTML = `
                <td class="p-1"><input type="text" class="form-input edit-input" value="" data-field="name"></td>
                <td class="p-1"><input type="text" class="form-input edit-input w-16 text-center" value="" data-field="sets"></td>
                <td class="p-1"><input type="text" class="form-input edit-input w-20 text-center" value="" data-field="reps"></td>
                <td class="p-1"><input type="text" class="form-input edit-input w-20 text-center" value="" data-field="rest"></td>
                <td class="p-1"><input type="text" class="form-input edit-input w-16 text-center" value="" data-field="rir"></td>
                <td class="p-1 text-center"><button class="btn-danger delete-exercise-btn">X</button></td>
            `;
        }
        if (e.target.classList.contains('delete-exercise-btn')) {
            e.target.closest('tr').remove();
        }
        if(e.target.id === 'revert-workout-btn'){
            showConfirm('¬øSeguro que quieres revertir la rutina a su estado original?', () => {
                workoutData[activeWorkoutDay] = JSON.parse(JSON.stringify(defaultWorkoutData[activeWorkoutDay]));
                saveWorkoutData();
                renderWorkout();
                showAlert('Rutina restaurada a la versi√≥n original.');
            });
        }
        if (e.target.id === 'delete-workout-day-btn') {
            const dayCount = Object.keys(workoutData).length;
            if (dayCount <= 1) {
                showAlert('No puedes eliminar el √∫ltimo d√≠a de entrenamiento.');
                return;
            }
            showConfirm(`¬øEst√°s seguro de que quieres eliminar permanentemente el D√≠a ${activeWorkoutDay}?`, () => {
                delete workoutData[activeWorkoutDay];
                saveWorkoutData();
                activeWorkoutDay = Object.keys(workoutData).sort((a,b) => a - b)[0];
                renderWorkout();
                showAlert(`D√≠a ${activeWorkoutDay} eliminado.`);
            });
        }
    });

    workoutNav.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') {
            if (e.target.id === 'add-workout-day-btn') {
                const dayNumbers = Object.keys(workoutData).map(Number);
                const newDayNumber = dayNumbers.length > 0 ? Math.max(...dayNumbers) + 1 : 1;
                workoutData[newDayNumber] = {
                    title: `D√≠a ${newDayNumber}: Nuevo Entrenamiento`,
                    description: 'Personaliza tu nuevo d√≠a de entrenamiento.',
                    main_work: [{name: 'Nuevo Ejercicio', sets: '3', reps: '10', rest: '90s', rir: '2'}],
                    specific_work: [],
                    cardio: { name: '', details: '' }
                };
                saveWorkoutData();
                activeWorkoutDay = newDayNumber.toString();
                renderWorkout();
                return;
            }

            if (isEditingWorkout) {
                showAlert('Guarda o cancela tus cambios antes de cambiar de d√≠a.');
                return;
            }
            activeWorkoutDay = e.target.dataset.day;
            renderWorkout();
        }
    });

    let measurements = JSON.parse(localStorage.getItem('fitnessMeasurementsDR')) || [];
    let notes = JSON.parse(localStorage.getItem('fitnessNotesDR')) || [];
    let lifts = JSON.parse(localStorage.getItem('fitnessLiftsDR')) || [];

    const measureForm = document.getElementById('measurement-form');
    const measureHistoryEl = document.getElementById('measurements-history');
    const notesForm = document.getElementById('notes-form');
    const notesHistoryEl = document.getElementById('notes-history');
    const liftForm = document.getElementById('lift-form');
    const liftHistoryEl = document.getElementById('lifts-history');
    const liftExerciseSelect = document.getElementById('lift-exercise');
    const liftFilterSelect = document.getElementById('lift-filter');

    function populateExerciseSelects() { const allExercises = [...new Set(Object.values(workoutData).flatMap(day => [...(day.main_work || []), ...(day.specific_work || [])].map(ex => ex.name)))].sort(); const currentLiftValue = liftExerciseSelect.value; const currentFilterValue = liftFilterSelect.value; liftFilterSelect.innerHTML = '<option value="all">Todos los Ejercicios</option>'; liftExerciseSelect.innerHTML = '<option value="">Selecciona Ejercicio</option>'; allExercises.forEach(ex => { if(ex) { liftExerciseSelect.innerHTML += `<option value="${ex}">${ex}</option>`; liftFilterSelect.innerHTML += `<option value="${ex}">${ex}</option>`; } }); liftExerciseSelect.value = currentLiftValue; liftFilterSelect.value = currentFilterValue; }
    function renderMeasurements() { measurements.sort((a,b)=>new Date(b.date)-new Date(a.date)); measureHistoryEl.innerHTML = measurements.map(m=>`<tr><td class="p-2">${new Date(m.date).toLocaleDateString('es-CO',{timeZone:'UTC'})}</td><td class="p-2">${m.weight||'N/A'} kg</td><td class="p-2">${m.waist||'N/A'} cm</td><td class="p-2">${m.chest||'N/A'} cm</td><td class="p-2">${m.arm||'N/A'} cm</td><td class="p-2 text-right"><button class="btn-danger delete-btn" data-type="measure" data-id="${m.id}">X</button></td></tr>`).join(''); }
    function renderNotes() { notes.sort((a,b)=>b.id-a.id); notesHistoryEl.innerHTML = notes.map(n=>`<div class="bg-black/20 p-3 rounded-lg"><p class="text-sm text-gray-300 whitespace-pre-wrap">${n.text}</p><div class="text-xs text-gray-500 mt-2 flex justify-between items-center">${n.date} <button class="btn-danger delete-btn" data-type="note" data-id="${n.id}">X</button></div></div>`).join(''); document.getElementById('analyze-wellness-btn').disabled = notes.length === 0; }
    function renderLifts() { lifts.sort((a, b) => new Date(b.date) - new Date(a.date)); const filter = liftFilterSelect.value; const filteredLifts = filter === 'all' ? lifts : lifts.filter(l => l.exercise === filter); liftHistoryEl.innerHTML = filteredLifts.map(l => `<tr><td class="p-2">${new Date(l.date).toLocaleDateString('es-CO', {timeZone:'UTC'})}</td><td class="p-2 font-semibold">${l.exercise}</td><td class="p-2">${l.weight} kg</td><td class="p-2">${l.reps}</td><td class="p-2 text-right"><button class="btn-danger delete-btn" data-type="lift" data-id="${l.id}">X</button></td></tr>`).join(''); }

    measureForm.addEventListener('submit', e=>{ e.preventDefault(); if(!e.target.elements['measure-date'].value) { showAlert('Selecciona una fecha.'); return;} measurements.push({id:Date.now(),date:e.target.elements['measure-date'].value,weight:e.target.elements['measure-weight'].value||'N/A',waist:e.target.elements['measure-waist'].value||'N/A',chest:e.target.elements['measure-chest'].value||'N/A',arm:e.target.elements['measure-arm'].value||'N/A'}); localStorage.setItem('fitnessMeasurementsDR', JSON.stringify(measurements)); renderMeasurements(); e.target.reset(); e.target.elements['measure-date'].valueAsDate = new Date(); });
    notesForm.addEventListener('submit', e=>{ e.preventDefault(); const text=e.target.elements['note-text'].value.trim(); if(!text) return; notes.push({id:Date.now(),date:new Date().toLocaleString('es-CO'),text}); localStorage.setItem('fitnessNotesDR',JSON.stringify(notes)); renderNotes(); e.target.reset(); });
    liftForm.addEventListener('submit', e=>{ e.preventDefault(); const exercise = e.target.elements['lift-exercise'].value; const weight = e.target.elements['lift-weight'].value; const reps = e.target.elements['lift-reps'].value; if(!exercise || !weight || !reps) { showAlert('Completa todos los campos del levantamiento.'); return;} lifts.push({id:Date.now(),date:new Date().toISOString().split('T')[0],exercise,weight,reps}); localStorage.setItem('fitnessLiftsDR',JSON.stringify(lifts)); renderLifts(); e.target.reset(); });
    document.getElementById('progreso').addEventListener('click', e => { if (e.target.classList.contains('delete-btn')) { const id = Number(e.target.dataset.id); const type = e.target.dataset.type; showConfirm('¬øEst√°s seguro de que quieres borrar este registro?', () => { if(type === 'measure') { measurements = measurements.filter(m => m.id !== id); localStorage.setItem('fitnessMeasurementsDR', JSON.stringify(measurements)); renderMeasurements(); } if(type === 'note') { notes = notes.filter(n => n.id !== id); localStorage.setItem('fitnessNotesDR', JSON.stringify(notes)); renderNotes(); } if(type === 'lift') { lifts = lifts.filter(l => l.id !== id); localStorage.setItem('fitnessLiftsDR', JSON.stringify(lifts)); renderLifts(); } }); } });
    liftFilterSelect.addEventListener('change', renderLifts);
    document.getElementById('1rm-form').addEventListener('submit', e => { e.preventDefault(); const w = parseFloat(e.target.elements['1rm-weight'].value); const r = parseInt(e.target.elements['1rm-reps'].value); if(w > 0 && r > 0){ const rm = w * (1 + (r/30)); document.getElementById('1rm-result').textContent = `1RM Estimado: ${rm.toFixed(1)} kg`; } else { document.getElementById('1rm-result').textContent = 'Datos inv√°lidos'; } });
    document.getElementById('rir-form').addEventListener('submit', e => { e.preventDefault(); const rm1 = parseFloat(e.target.elements['rir-1rm'].value); const reps = parseInt(e.target.elements['rir-reps'].value); const rir = parseInt(e.target.elements['rir-rir'].value); if(rm1 > 0 && reps > 0 && rir >= 0){ const totalReps = reps + rir; const intensity = 1 - (0.025 * totalReps); const weight = rm1 * intensity; document.getElementById('rir-result').textContent = `Peso Sugerido: ${weight.toFixed(1)} kg`; } else { document.getElementById('rir-result').textContent = 'Datos inv√°lidos'; } });

    const productDatabase = { "7501055300077": { name: "Coca-Cola Original (355ml)", calories: 149, protein: 0, carbs: 39, fat: 0 }, "888849003611": { name: "Quest Bar - Chocolate Chip", calories: 190, protein: 21, carbs: 22, fat: 9 }, "086600244108": { name: "At√∫n en Agua (lata 142g)", calories: 120, protein: 26, carbs: 0, fat: 1.5 } };
    const aiResultLoader = document.getElementById('ai-result-loader');
    const aiResultContent = document.getElementById('ai-result-content');
    const dailyLogHistory = document.getElementById('daily-log-history');
    const dailyLogProgress = document.getElementById('daily-log-progress');
    let dailyLog = JSON.parse(localStorage.getItem('fitAIDailyLogDR')) || { date: new Date().toISOString().split('T')[0], meals: [], totals: { calories: 0, protein: 0, carbs: 0, fat: 0 }};
    const aiModal = document.getElementById('ai-modal');
    const aiModalTitle = document.getElementById('ai-modal-title');
    const aiModalContent = document.getElementById('ai-modal-content');
    const aiModalLoaderEl = document.getElementById('ai-modal-loader');
    const aiModalClose = document.getElementById('ai-modal-close');

    function showAiModal(title, content = '') { aiModalTitle.textContent = title; aiModalContent.innerHTML = content; aiModalLoaderEl.style.display = 'none'; aiModal.style.display = 'block'; }
    function showAiModalLoading(title) { aiModalTitle.textContent = title; aiModalContent.innerHTML = ''; aiModalLoaderEl.style.display = 'flex'; aiModal.style.display = 'block'; }
    function hideAiModal() { aiModal.style.display = 'none'; }
    aiModalClose.addEventListener('click', hideAiModal);
    function setButtonsLoading(isLoading) { document.querySelectorAll('.btn-primary, .btn-secondary.ai-action-btn').forEach(btn => btn.disabled = isLoading); }
    function checkDateAndResetLog() { const today = new Date().toISOString().split('T')[0]; if (dailyLog.date !== today) { dailyLog = { date: today, meals: [], totals: { calories: 0, protein: 0, carbs: 0, fat: 0 } }; saveDailyLog(); } }
    function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); }
    function setAILoading(isLoading) { aiResultLoader.style.display = isLoading ? 'flex' : 'none'; aiResultContent.style.display = isLoading ? 'none' : 'block'; if(isLoading) aiResultContent.innerHTML = ''; }

    async function callGeminiAPI(prompt, base64ImageData = null) {
        setButtonsLoading(true);
        const apiKey = "AIzaSyB2CH17D7HzmB1eJ6h7KIxNlBx6bF_QrnU"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
        let userParts = [{ text: prompt }];
        if (base64ImageData) { userParts.push({ inlineData: { mimeType: "image/jpeg", data: base64ImageData } }); }
        const payload = { contents: [{ role: "user", parts: userParts }], generationConfig: { responseMimeType: "application/json" } };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const errorBody = await response.text(); throw new Error(`Error en la API: ${response.statusText}. Detalles: ${errorBody}`); }
            const result = await response.json();
            if (result.candidates && result.candidates[0].finishReason === "SAFETY") { throw new Error("La solicitud fue bloqueada por pol√≠ticas de seguridad. Intenta con una consulta diferente."); }
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                try {
                    const rawText = result.candidates[0].content.parts[0].text;
                    const cleanText = rawText.replace(/^```json\s*/, '').replace(/```$/, '');
                    return JSON.parse(cleanText);
                } catch(parseError) { throw new Error(`Error al procesar la respuesta de la API. Respuesta no es un JSON v√°lido. ${parseError.message}`); }
            } else { throw new Error("Respuesta inv√°lida o vac√≠a de la API."); }
        } catch (error) { console.error("Error llamando a la API de Gemini:", error); showAlert(`Error de IA: ${error.message}`); return { error: error.message }; } finally { setButtonsLoading(false); }
    }

    function renderAnalysisResult(data) { if (!data || data.error) { aiResultContent.innerHTML = `<p class="text-red-400">Error: ${data?.error || 'No se pudo procesar la solicitud.'}</p>`; return; } const mealData = { id: Date.now(), name: data.name || "Comida Desconocida", calories: parseInt(data.calories) || 0, protein: parseInt(data.protein) || 0, carbs: parseInt(data.carbs) || 0, fat: parseInt(data.fat) || 0 }; let html = `<h4 class="text-xl font-bold text-white mb-2">${mealData.name}</h4>`; html += `<div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center mb-4"><div><p class="text-sm text-gray-400">Calor√≠as</p><p class="font-bold text-lg">${mealData.calories}</p></div><div><p class="text-sm text-red-400">Prote√≠na</p><p class="font-bold text-lg">${mealData.protein}g</p></div><div><p class="text-sm text-gray-300">Carbs</p><p class="font-bold text-lg">${mealData.carbs}g</p></div><div><p class="text-sm text-gray-500">Grasas</p><p class="font-bold text-lg">${mealData.fat}g</p></div></div>`; if (data.ingredients?.length > 0) { html += `<div class="text-left mt-4"><h5 class="font-semibold mb-2">Ingredientes Sugeridos:</h5><ul class="list-disc list-inside text-gray-300 text-sm space-y-1">${data.ingredients.map(i => `<li>${i}</li>`).join('')}</ul></div>`; } html += `<button id="add-to-log-btn" class="btn-primary w-full mt-4">A√±adir al registro diario</button>`; aiResultContent.innerHTML = html; document.getElementById('add-to-log-btn').onclick = () => { addMealToLog(mealData); aiResultContent.innerHTML = `<p class="text-green-400 font-bold text-center">¬°A√±adido a tu registro!</p>`; document.getElementById('image-preview').classList.add('hidden'); document.getElementById('recipe-search-input').value = ''; }; }
    function saveDailyLog() { localStorage.setItem('fitAIDailyLogDR', JSON.stringify(dailyLog)); }
    function addMealToLog(meal) { dailyLog.meals.push(meal); dailyLog.totals.calories += meal.calories; dailyLog.totals.protein += meal.protein; dailyLog.totals.carbs += meal.carbs; dailyLog.totals.fat += meal.fat; saveDailyLog(); renderDailyLog(); }
    function renderDailyLog() { dailyLogHistory.innerHTML = dailyLog.meals.length > 0 ? dailyLog.meals.map(m => `<div class="bg-black/20 p-3 rounded-lg text-sm"><div class="flex justify-between items-start"><p class="font-semibold text-white flex-1 pr-2">${m.name}</p><button class="btn-danger delete-btn" data-type="log" data-id="${m.id}">X</button></div><p class="text-gray-400 mt-1">${m.calories}kcal | P:${m.protein}g C:${m.carbs}g G:${m.fat}g</p></div>`).join('') : '<p class="text-center text-gray-500">No hay comidas registradas hoy.</p>'; const totals = dailyLog.totals; const targets = macroData; const progressData = [ { label: 'Calor√≠as', current: totals.calories, target: targets.calorias, color: 'bg-yellow-500' }, { label: 'Prote√≠na', current: totals.protein, target: targets.proteina, color: 'bg-red-500' }, { label: 'Carbs', current: totals.carbs, target: targets.carbs, color: 'bg-blue-500' }, { label: 'Grasas', current: totals.fat, target: targets.grasas, color: 'bg-purple-500' }, ]; dailyLogProgress.innerHTML = progressData.map(p => { const percentage = p.target > 0 ? Math.min((p.current / p.target) * 100, 100) : 0; return `<div class="mb-3"><div class="flex justify-between items-baseline mb-1 text-sm"><span class="font-bold">${p.label}</span><span class="text-gray-400">${Math.round(p.current)} / ${p.target} ${p.label === 'Calor√≠as' ? 'kcal' : 'g'}</span></div><div class="progress-bar-bg h-2.5 w-full"><div class="progress-bar ${p.color}" style="width: ${percentage}%"></div></div></div>`; }).join(''); }
    
    document.getElementById('analyze-image-btn').addEventListener('click', async () => { const file = document.getElementById('food-image-input').files[0]; if (!file) { showAlert('Por favor, selecciona una imagen primero.'); return; } setAILoading(true); try { const base64ImageData = await toBase64(file); const prompt = "Analiza la imagen de esta comida. Identifica los alimentos y estima la cantidad de calor√≠as, prote√≠nas, carbohidratos y grasas. Devuelve la respuesta √∫nicamente como un objeto JSON con las siguientes claves: 'name' (un nombre descriptivo para la comida), 'calories', 'protein', 'carbs', 'fat', y 'ingredients' (un array de strings con los ingredientes que identificas)."; const result = await callGeminiAPI(prompt, base64ImageData); renderAnalysisResult(result); } catch (error) { aiResultContent.innerHTML = `<p class="text-red-500">Error al analizar la imagen: ${error.message}</p>`; } finally { setAILoading(false); } });
    document.getElementById('food-image-input').addEventListener('change', (event) => { const imagePreview = document.getElementById('image-preview'); if (event.target.files?.[0]) { const reader = new FileReader(); reader.onload = (e) => { imagePreview.src = e.target.result; imagePreview.classList.remove('hidden'); }; reader.readAsDataURL(event.target.files[0]); } });
    document.getElementById('clear-log-btn').addEventListener('click', () => { showConfirm('¬øEst√°s seguro de que quieres borrar todas las comidas de hoy?', () => { dailyLog.meals = []; dailyLog.totals = { calories: 0, protein: 0, carbs: 0, fat: 0 }; saveDailyLog(); renderDailyLog(); }); });
    dailyLogHistory.addEventListener('click', (e) => { if (e.target.classList.contains('delete-btn') && e.target.dataset.type === 'log') { const mealId = Number(e.target.dataset.id); const mealToRemove = dailyLog.meals.find(m => m.id === mealId); if (mealToRemove) { showConfirm('¬øSeguro que quieres borrar esta comida del registro?', () => { dailyLog.totals.calories -= mealToRemove.calories; dailyLog.totals.protein -= mealToRemove.protein; dailyLog.totals.carbs -= mealToRemove.carbs; dailyLog.totals.fat -= mealToRemove.fat; dailyLog.meals = dailyLog.meals.filter(m => m.id !== mealId); saveDailyLog(); renderDailyLog(); }); } } });
    document.getElementById('recipe-search-form').addEventListener('submit', async (e) => { e.preventDefault(); const searchTerm = document.getElementById('recipe-search-input').value.trim(); if (searchTerm.length < 3) { showAlert('Introduce un t√©rmino de b√∫squeda m√°s largo.'); return; } setAILoading(true); try { const prompt = `Genera una receta simple y saludable para "${searchTerm}". Incluye una estimaci√≥n de sus macros. Devuelve la respuesta √∫nicamente como un objeto JSON con las siguientes claves: 'name' (nombre de la receta), 'calories', 'protein', 'carbs', 'fat', y 'ingredients' (un array de strings).`; const result = await callGeminiAPI(prompt); renderAnalysisResult(result); } catch (error) { aiResultContent.innerHTML = `<p class="text-red-500">Error al buscar la receta: ${error.message}</p>`; } finally { setAILoading(false); } });
    document.getElementById('meal-plan-form').addEventListener('submit', async (e) => { e.preventDefault(); const prefs = document.getElementById('meal-plan-prefs').value.trim(); showAiModalLoading("‚ú® Generando tu Plan de Comidas..."); try { const prompt = `Eres un nutricionista experto en fitness. Genera un plan de comidas de un d√≠a completo para alcanzar los siguientes objetivos: ${macroData.calorias} kcal, ${macroData.proteina}g de prote√≠na, ${macroData.carbs}g de carbohidratos, y ${macroData.grasas}g de grasa. ${prefs ? `Considera las siguientes preferencias del usuario: ${prefs}.` : ''} El plan debe tener 5 comidas. Para cada comida, proporciona su nombre, una lista de ingredientes con cantidades, y los macros estimados. La suma total de los macros del d√≠a debe ser lo m√°s cercana posible a los objetivos. Devuelve la respuesta √öNICAMENTE como un objeto JSON con la clave "meal_plan", que es un array de objetos. Cada objeto de comida debe tener las claves "name", "ingredients" (array de strings), y "macros" (un objeto con "calories", "protein", "carbs", "fat").`; const result = await callGeminiAPI(prompt); if (result.error) throw new Error(result.error); let totalCalculated = {calories: 0, protein: 0, carbs: 0, fat: 0}; let mealPlanHtml = result.meal_plan.map(meal => { totalCalculated.calories += meal.macros.calories; totalCalculated.protein += meal.macros.protein; totalCalculated.carbs += meal.macros.carbs; totalCalculated.fat += meal.macros.fat; return `<div class="bg-black/20 p-4 rounded-lg mb-4 border border-gray-800"><h4 class="font-bold text-red-500 text-lg">${meal.name}</h4><ul class="list-disc list-inside text-gray-300 text-sm my-2 space-y-1 pl-2">${meal.ingredients.map(i => `<li>${i}</li>`).join('')}</ul><div class="text-xs grid grid-cols-4 gap-2 text-center mt-3 bg-black/30 p-2 rounded-md"><div><span class="font-bold text-gray-400">Calor√≠as</span><br>${meal.macros.calories}</div><div><span class="font-bold text-red-400">Prote√≠na</span><br>${meal.macros.protein}g</div><div><span class="font-bold text-gray-200">Carbs</span><br>${meal.macros.carbs}g</div><div><span class="font-bold text-gray-500">Grasas</span><br>${meal.macros.fat}g</div></div></div>`; }).join(''); const totalsHtml = `<div class="bg-gray-900 p-4 rounded-lg mt-6 border border-red-500/50"><h4 class="font-bold text-white text-lg text-center mb-2">Totales Estimados del D√≠a</h4><div class="text-sm grid grid-cols-2 md:grid-cols-4 gap-3 text-center"><div><p class="font-bold">Calor√≠as</p><p>${totalCalculated.calories} / ${macroData.calorias}</p></div><div><p class="font-bold text-red-400">Prote√≠na</p><p>${totalCalculated.protein}g / ${macroData.proteina}g</p></div><div><p class="font-bold text-gray-200">Carbs</p><p>${totalCalculated.carbs}g / ${macroData.carbs}g</p></div><div><p class="font-bold text-gray-500">Grasas</p><p>${totalCalculated.fat}g / ${macroData.grasas}g</p></div></div></div>`; aiModalContent.innerHTML = mealPlanHtml + totalsHtml; aiModalLoaderEl.style.display = 'none'; } catch(error) { aiModalContent.innerHTML = `<p class="text-red-500 text-center">Hubo un error al generar el plan: ${error.message}</p>`; aiModalLoaderEl.style.display = 'none'; } });
    document.getElementById('analyze-progress-btn').addEventListener('click', async () => { if (measurements.length < 2 && lifts.length < 3) { showAlert('Necesitas registrar al menos 2 mediciones y 3 levantamientos para un an√°lisis significativo.'); return; } showAiModalLoading("‚ú® Analizando tu Progreso..."); try { const prompt = `Eres un coach de fitness experto y motivador. Analiza los datos de progreso de un usuario y escribe un resumen positivo y alentador en espa√±ol. Compara las primeras y √∫ltimas mediciones para resaltar cambios. Menciona el mejor levantamiento (calculado como peso * repeticiones). Si detectas un posible estancamiento en alg√∫n ejercicio (m√∫ltiples registros sin mejora), sugiere amablemente una t√©cnica para romperlo (ej. dropset, pausa-descanso, o cambiar de ejercicio). Mant√©n el an√°lisis conciso y en un tono inspirador. Los datos del usuario son: Medidas: ${JSON.stringify(measurements)}. Levantamientos: ${JSON.stringify(lifts)}. Devuelve la respuesta √öNICAMENTE como un objeto JSON con la clave "analysis_text" que contenga tu an√°lisis como un string con formato de p√°rrafos (usa \\n para saltos de l√≠nea).`; const result = await callGeminiAPI(prompt); if (result.error) throw new Error(result.error); const formattedText = result.analysis_text.replace(/\\n/g, '<br><br>'); aiModalContent.innerHTML = `<p class="text-gray-300 leading-relaxed">${formattedText}</p>`; aiModalLoaderEl.style.display = 'none'; } catch (error) { aiModalContent.innerHTML = `<p class="text-red-500 text-center">Hubo un error al analizar tu progreso: ${error.message}</p>`; aiModalLoaderEl.style.display = 'none'; } });
    workoutContent.addEventListener('click', async (e) => { const target = e.target.closest('.ai-action-btn'); if (!target) return; const exerciseName = target.dataset.exerciseName; const handleResult = (result, type) => { if (result.error) throw new Error(result.error); if (type === 'explain') { const formattedText = result.explanation_text.replace(/\n/g, '<br><br>').replace(/\*/g, '&bull; '); aiModalContent.innerHTML = `<p class="text-gray-300 leading-relaxed">${formattedText}</p>`; } else if (type === 'variation') { let alternativesHtml = result.alternatives.map(alt => `<div class="bg-black/20 p-4 rounded-lg mb-3 border border-gray-800"><h4 class="font-bold text-red-400">${alt.name}</h4><p class="text-gray-300 text-sm mt-1">${alt.description}</p></div>`).join(''); aiModalContent.innerHTML = alternativesHtml; } aiModalLoaderEl.style.display = 'none'; }; const handleError = (error, action) => { aiModalContent.innerHTML = `<p class="text-red-500 text-center">Hubo un error al ${action}: ${error.message}</p>`; aiModalLoaderEl.style.display = 'none'; }; if (target.classList.contains('btn-explain')) { showAiModalLoading(`‚ú® Explicando: ${exerciseName}`); const prompt = `Eres un entrenador personal experto. Proporciona una gu√≠a detallada y clara, paso a paso, sobre c√≥mo realizar correctamente el ejercicio '${exerciseName}'. Incluye puntos clave sobre la postura, el movimiento y 2-3 errores comunes a evitar. Responde √∫nicamente con un objeto JSON con la clave "explanation_text" que contenga el texto formateado con saltos de l√≠nea (usa \\n para p√°rrafos y '*' para listas).`; try { const result = await callGeminiAPI(prompt); handleResult(result, 'explain'); } catch (error) { handleError(error, 'obtener la explicaci√≥n'); } } if (target.classList.contains('btn-variation')) { showAiModalLoading(`‚ú® Alternativas para: ${exerciseName}`); const prompt = `Eres un entrenador personal creativo. Sugiere 3 ejercicios alternativos para '${exerciseName}'. Para cada alternativa, proporciona su nombre y una breve descripci√≥n de por qu√© es una buena variaci√≥n (ej. diferente equipo, enfoca una parte ligeramente distinta del m√∫sculo). Responde √∫nicamente con un objeto JSON con una clave 'alternatives', que es un array de objetos, donde cada objeto tiene las claves 'name' y 'description'.`; try { const result = await callGeminiAPI(prompt); handleResult(result, 'variation'); } catch (error) { handleError(error, 'sugerir alternativas'); } } });
    async function startScanner() { const scannerModal = document.getElementById('barcode-scanner-modal'); const videoElement = document.getElementById('video-scanner'); codeReader = new ZXing.BrowserMultiFormatReader(); scannerModal.style.display = 'block'; try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); cameraStream = stream; videoElement.srcObject = stream; codeReader.decodeFromStream(stream, videoElement, (result, err) => { if (result) { stopScanner(); const barcode = result.getText(); const product = productDatabase[barcode]; if (product) { renderAnalysisResult(product); } else { aiResultContent.innerHTML = `<p class="text-yellow-400 text-center">Producto no encontrado en la base de datos local (C√≥digo: ${barcode}).<br>Prueba a buscarlo por nombre o analizar su tabla nutricional con la c√°mara.</p>`; } } if (err && !(err instanceof ZXing.NotFoundException)) { console.error(err); showAlert(`Error del esc√°ner: ${err.message}`); stopScanner(); } }); } catch (err) { console.error("Error al acceder a la c√°mara:", err); showAlert(`No se pudo acceder a la c√°mara. Por favor, aseg√∫rate de haber dado permiso. Error: ${err.message}`); stopScanner(); } }
    function stopScanner() { if (codeReader) { codeReader.reset(); } if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; } document.getElementById('barcode-scanner-modal').style.display = 'none'; }
    document.getElementById('scan-barcode-btn').addEventListener('click', startScanner);
    document.getElementById('close-scanner-btn').addEventListener('click', stopScanner);
    document.getElementById('change-goal-ai-btn').addEventListener('click', () => { const modalContent = `<p class="text-gray-400 mb-4">Describe tu nuevo objetivo f√≠sico. Por ejemplo: "Quiero ganar masa muscular y peso", "Busco perder 5 kilos y definir", o "Necesito m√°s energ√≠a para mis entrenamientos".</p><form id="change-goal-form"><textarea id="goal-input" class="form-textarea" rows="3" placeholder="Mi nuevo objetivo es..."></textarea><button type="submit" class="btn-primary w-full mt-4">Calcular Nuevos Macros</button></form>`; showAiModal('‚ú® Ajustar Objetivo con IA', modalContent); document.getElementById('change-goal-form').addEventListener('submit', async (e) => { e.preventDefault(); const goal = document.getElementById('goal-input').value.trim(); if (!goal) { showAlert('Por favor, describe tu objetivo.'); return; } showAiModalLoading('Calculando nuevos macros...'); const prompt = `Un usuario de fitness describe su nuevo objetivo como: "${goal}". Sus macros actuales son: Calor√≠as: ${macroData.calorias}, Prote√≠na: ${macroData.proteina}g, Carbs: ${macroData.carbs}g, Grasas: ${macroData.grasas}g. Basado en este nuevo objetivo, calcula y devuelve un nuevo conjunto de macros. Responde √öNICAMENTE con un objeto JSON con las claves: "calorias", "proteina", "carbs", "grasas". Los valores deben ser num√©ricos.`; try { const result = await callGeminiAPI(prompt); if (result.error) throw new Error(result.error); if (result.calorias && result.proteina && result.carbs && result.grasas) { macroData = result; localStorage.setItem('fitnessMacroDataDR', JSON.stringify(macroData)); updateMacroDisplay(); hideAiModal(); showAlert('¬°Tus objetivos nutricionales han sido actualizados y guardados!'); } else { throw new Error("La respuesta de la IA no ten√≠a el formato esperado."); } } catch (error) { aiModalContent.innerHTML = `<p class="text-red-500 text-center">Hubo un error al generar la sugerencia: ${error.message}</p>`; aiModalLoaderEl.style.display = 'none'; } }); });
    
    aiEditBtn.addEventListener('click', () => {
        const modalContent = `<p class="text-gray-400 mb-4">Describe qu√© quieres cambiar en la rutina de hoy. Puedes pedir a√±adir un nuevo ejercicio, modificar uno existente (cambiar series, reps, etc.) o incluso reemplazar la rutina completa por un nuevo enfoque.</p><form id="modify-workout-form"><textarea id="workout-modification-input" class="form-textarea" rows="4" placeholder="Ej: Quiero reemplazar el press de banca por press con mancuernas, y a√±adir un ejercicio m√°s para hombro."></textarea><button type="submit" class="btn-primary w-full mt-4">Actualizar Rutina con IA</button></form>`;
        showAiModal(`ü¶æ Editar D√≠a ${activeWorkoutDay}: ${workoutData[activeWorkoutDay].title}`, modalContent);
        document.getElementById('modify-workout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const request = document.getElementById('workout-modification-input').value.trim();
            if (!request) { showAlert('Por favor, describe tu petici√≥n.'); return; }
            showAiModalLoading('Aplicando cambios a la rutina...');
            const currentWorkoutJSON = JSON.stringify(workoutData[activeWorkoutDay]);
            const prompt = `Act√∫a como un preparador f√≠sico de √©lite de nivel mundial. Un atleta te ha pedido ajustar su plan de entrenamiento para hoy. Su solicitud espec√≠fica es: "${request}". La rutina actual para hoy se encuentra en este objeto JSON: ${currentWorkoutJSON}. Tu tarea es analizar la solicitud y reescribir el objeto JSON completo para reflejar los cambios de la manera m√°s inteligente y fisiol√≥gicamente sensata posible. Mant√©n la estructura exacta del JSON (claves: title, description, main_work, specific_work, cardio). El array 'main_work' es para los ejercicios compuestos principales, y 'specific_work' para accesorios o aislamiento. Aseg√∫rate de que las propiedades de cada ejercicio (name, sets, reps, rest, rir) sean coherentes y est√©n bien fundamentadas. Tu respuesta DEBE ser exclusivamente el objeto JSON modificado, sin ning√∫n texto, explicaci√≥n o markdown adicional.`;
            try {
                const result = await callGeminiAPI(prompt);
                if (result.error) throw new Error(result.error);
                if (result.title && result.main_work) {
                    workoutData[activeWorkoutDay] = result;
                    saveWorkoutData();
                    renderWorkout();
                    hideAiModal();
                    showAlert('¬°Tu rutina ha sido actualizada y guardada con √©xito!');
                } else {
                    throw new Error("La IA devolvi√≥ una estructura de rutina inv√°lida.");
                }
            } catch (error) {
                hideAiModal();
                showAlert(`Error al modificar la rutina: ${error.message}`);
            }
        });
    });

    const photoCaptureModal = document.getElementById('photo-capture-modal');
    const videoCaptureEl = document.getElementById('video-capture');
    document.getElementById('take-food-photo-btn').addEventListener('click', async () => { photoCaptureModal.style.display = 'block'; try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); videoCaptureEl.srcObject = cameraStream; } catch (err) { showAlert(`Error al acceder a la c√°mara: ${err.message}`); photoCaptureModal.style.display = 'none'; } });
    document.getElementById('cancel-capture-btn').addEventListener('click', () => { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); } photoCaptureModal.style.display = 'none'; });
    document.getElementById('capture-photo-btn').addEventListener('click', async () => { const canvas = document.createElement('canvas'); canvas.width = videoCaptureEl.videoWidth; canvas.height = videoCaptureEl.videoHeight; const context = canvas.getContext('2d'); context.drawImage(videoCaptureEl, 0, 0, canvas.width, canvas.height); if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); } photoCaptureModal.style.display = 'none'; const base64ImageData = canvas.toDataURL('image/jpeg').split(',')[1]; setAILoading(true); try { const prompt = "Analiza la imagen de esta comida. Identifica los alimentos y estima la cantidad de calor√≠as, prote√≠nas, carbohidratos y grasas. Devuelve la respuesta √∫nicamente como un objeto JSON con las siguientes claves: 'name', 'calories', 'protein', 'carbs', 'fat', y 'ingredients'."; const result = await callGeminiAPI(prompt, base64ImageData); renderAnalysisResult(result); } catch (error) { aiResultContent.innerHTML = `<p class="text-red-500">Error al analizar la foto: ${error.message}</p>`; } finally { setAILoading(false); } });
    document.getElementById('analyze-wellness-btn').addEventListener('click', async () => { if (notes.length === 0) { showAlert('No hay notas para analizar. Escribe algunas notas primero.'); return; } showAiModalLoading("‚ú® Analizando tu Bienestar..."); const allNotesText = notes.map(n => n.text).join('\n---\n'); const prompt = `Eres un coach de bienestar y fitness. Analiza las siguientes notas de un usuario en busca de patrones sobre sue√±o, estr√©s, energ√≠a y motivaci√≥n: "${allNotesText}". Basado en tu an√°lisis, proporciona 2-3 consejos pr√°cticos y accionables en espa√±ol para ayudar al usuario a mejorar estas √°reas y, como consecuencia, su rendimiento f√≠sico. Responde √öNICAMENTE como un objeto JSON con una clave "wellness_tips", que es un array de strings, donde cada string es un consejo.`; try { const result = await callGeminiAPI(prompt); if (result.error) throw new Error(result.error); let tipsHtml = result.wellness_tips.map(tip => `<div class="bg-black/20 p-4 rounded-lg mb-3 border border-gray-800"><p class="text-gray-300">${tip}</p></div>`).join(''); aiModalTitle.textContent = "Consejos de Bienestar"; aiModalContent.innerHTML = tipsHtml; aiModalLoaderEl.style.display = 'none'; } catch (error) { aiModalContent.innerHTML = `<p class="text-red-500 text-center">Hubo un error al analizar tus notas: ${error.message}</p>`; aiModalLoaderEl.style.display = 'none'; } });
    document.getElementById('supplement-form').addEventListener('submit', async (e) => { e.preventDefault(); const goal = document.getElementById('supplement-goal').value.trim(); if (!goal) { showAlert('Por favor, describe tu objetivo para la suplementaci√≥n.'); return; } showAiModalLoading("‚ú® Generando Sugerencia de Suplementos..."); const prompt = `Eres un asistente de IA con conocimientos sobre suplementaci√≥n deportiva. Un usuario tiene el objetivo de "${goal}". Sugiere un stack b√°sico y seguro de 2-3 suplementos comunes. Para cada uno, proporciona su nombre, el principal beneficio relacionado con el objetivo del usuario y una recomendaci√≥n de uso com√∫n (dosis y timing). IMPORTANTE: Incluye un descargo de responsabilidad claro. Responde √öNICAMENTE como un objeto JSON con dos claves: "disclaimer" (string con el descargo de responsabilidad) y "supplement_stack" (un array de objetos, donde cada objeto tiene las claves "name", "benefit" y "usage").`; try { const result = await callGeminiAPI(prompt); if (result.error) throw new Error(result.error); let stackHtml = `<div class="p-4 mb-4 rounded-lg bg-yellow-900/50 border border-yellow-400"><p class="font-bold text-yellow-300">IMPORTANTE:</p><p class="text-sm text-yellow-300">${result.disclaimer}</p></div>`; stackHtml += result.supplement_stack.map(sup => `<div class="bg-black/20 p-4 rounded-lg mb-3 border border-gray-800"><h4 class="font-bold text-red-400 text-lg">${sup.name}</h4><p class="text-gray-300 mt-2"><strong class="font-semibold text-white">Beneficio:</strong> ${sup.benefit}</p><p class="text-gray-300 mt-1"><strong class="font-semibold text-white">Uso sugerido:</strong> ${sup.usage}</p></div>`).join(''); aiModalTitle.textContent = "Sugerencia de Suplementos"; aiModalContent.innerHTML = stackHtml; aiModalLoaderEl.style.display = 'none'; } catch (error) { aiModalContent.innerHTML = `<p class="text-red-500 text-center">Hubo un error al generar la sugerencia: ${error.message}</p>`; aiModalLoaderEl.style.display = 'none'; } });

    // ===== INICIALIZACI√ìN DE LA P√ÅGINA =====
    document.getElementById('measure-date').valueAsDate = new Date();
    renderMeasurements(); 
    renderNotes(); 
    renderLifts();
    renderWorkout(); // Llama a la funci√≥n principal de renderizado de entrenamiento
    checkDateAndResetLog();
    renderDailyLog();
    updateMacroDisplay(); 
});
</script>
</body>
</html>
